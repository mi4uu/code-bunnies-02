# Crate Documentation

**Version:** 0.5.7

**Format Version:** 43

# Module `reqwest_tracing`

Opentracing middleware implementation for [`reqwest_middleware`].

Attach [`TracingMiddleware`] to your client to automatically trace HTTP requests.

The simplest possible usage:
```no_run
# use reqwest_middleware::Result;
use reqwest_middleware::{ClientBuilder};
use reqwest_tracing::TracingMiddleware;

# async fn example() -> Result<()> {
let reqwest_client = reqwest::Client::builder().build().unwrap();
let client = ClientBuilder::new(reqwest_client)
   // Insert the tracing middleware
   .with(TracingMiddleware::default())
   .build();

let resp = client.get("https://truelayer.com").send().await.unwrap();
# Ok(())
# }
```

To customise the span names use [`OtelName`].
```no_run
# use reqwest_middleware::Result;
use reqwest_middleware::{ClientBuilder, Extension};
use reqwest_tracing::{
    TracingMiddleware, OtelName
};
# async fn example() -> Result<()> {
let reqwest_client = reqwest::Client::builder().build().unwrap();
let client = ClientBuilder::new(reqwest_client)
   // Inserts the extension before the request is started
   .with_init(Extension(OtelName("my-client".into())))
   // Makes use of that extension to specify the otel name
   .with(TracingMiddleware::default())
   .build();

let resp = client.get("https://truelayer.com").send().await.unwrap();

// Or specify it on the individual request (will take priority)
let resp = client.post("https://api.truelayer.com/payment")
    .with_extension(OtelName("POST /payment".into()))
   .send()
   .await
   .unwrap();
# Ok(())
# }
```

In this example we define a custom span builder to calculate the request time elapsed and we register the [`TracingMiddleware`].

Note that Opentelemetry tracks start and stop already, there is no need to have a custom builder like this.
```rust
use reqwest_middleware::Result;
use http::Extensions;
use reqwest::{Request, Response};
use reqwest_middleware::ClientBuilder;
use reqwest_tracing::{
    default_on_request_end, reqwest_otel_span, ReqwestOtelSpanBackend, TracingMiddleware
};
use tracing::Span;
use std::time::{Duration, Instant};

pub struct TimeTrace;

impl ReqwestOtelSpanBackend for TimeTrace {
    fn on_request_start(req: &Request, extension: &mut Extensions) -> Span {
        extension.insert(Instant::now());
        reqwest_otel_span!(name="example-request", req, time_elapsed = tracing::field::Empty)
    }

    fn on_request_end(span: &Span, outcome: &Result<Response>, extension: &mut Extensions) {
        let time_elapsed = extension.get::<Instant>().unwrap().elapsed().as_millis() as i64;
        default_on_request_end(span, outcome);
        span.record("time_elapsed", &time_elapsed);
    }
}

let http = ClientBuilder::new(reqwest::Client::new())
    .with(TracingMiddleware::<TimeTrace>::new())
    .build();
```

## Macros

### Macro `reqwest_otel_span`

**Attributes:**

- `#[macro_export]`

[`reqwest_otel_span!`](crate::reqwest_otel_span) creates a new [`tracing::Span`].
It empowers you to add custom properties to the span on top of the default properties provided by the macro

Default Fields:
- http.request.method
- url.scheme
- server.address
- server.port
- otel.kind
- otel.name
- otel.status_code
- user_agent.original
- http.response.status_code
- error.message
- error.cause_chain

Here are some convenient functions to checkout [`default_on_request_success`], [`default_on_request_failure`],
and [`default_on_request_end`].

# Why a macro?

[`tracing`] requires all the properties attached to a span to be declared upfront, when the span is created.
You cannot add new ones afterwards.
This makes it extremely fast, but it pushes us to reach for macros when we need some level of composition.

# Macro syntax

The first argument is a [span name](https://opentelemetry.io/docs/reference/specification/trace/api/#span).
The second argument passed to [`reqwest_otel_span!`](crate::reqwest_otel_span) is a reference to an [`reqwest::Request`].

```rust
use reqwest_middleware::Result;
use http::Extensions;
use reqwest::{Request, Response};
use reqwest_tracing::{
    default_on_request_end, reqwest_otel_span, ReqwestOtelSpanBackend
};
use tracing::Span;

pub struct CustomReqwestOtelSpanBackend;

impl ReqwestOtelSpanBackend for CustomReqwestOtelSpanBackend {
    fn on_request_start(req: &Request, _extension: &mut Extensions) -> Span {
        reqwest_otel_span!(name = "reqwest-http-request", req)
    }

    fn on_request_end(span: &Span, outcome: &Result<Response>, _extension: &mut Extensions) {
        default_on_request_end(span, outcome)
    }
}
```

If nothing else is specified, the span generated by `reqwest_otel_span!` is identical to the one you'd
get by using [`DefaultSpanBackend`]. Note that to avoid leaking sensitive information, the
macro doesn't include `url.full`, even though it's required by opentelemetry. You can add the
URL attribute explicitly by using [`SpanBackendWithUrl`] instead of `DefaultSpanBackend` or
adding the field on your own implementation.

You can define new fields following the same syntax of [`tracing::info_span!`] for fields:

```rust,should_panic
use reqwest_tracing::reqwest_otel_span;
# let request: &reqwest::Request = todo!();

// Define a `time_elapsed` field as empty. It might be populated later.
// (This example is just to show how to inject data - otel already tracks durations)
reqwest_otel_span!(name = "reqwest-http-request", request, time_elapsed = tracing::field::Empty);

// Define a `name` field with a known value, `AppName`.
reqwest_otel_span!(name = "reqwest-http-request", request, name = "AppName");

// Define an `app_id` field using the variable with the same name as value.
let app_id = "XYZ";
reqwest_otel_span!(name = "reqwest-http-request", request, app_id);

// All together
reqwest_otel_span!(name = "reqwest-http-request", request, time_elapsed = tracing::field::Empty, name = "AppName", app_id);
```

You can also choose to customise the level of the generated span:

```rust,should_panic
use reqwest_tracing::reqwest_otel_span;
use tracing::Level;
# let request: &reqwest::Request = todo!();

// Reduce the log level for service endpoints/probes
let level = if request.method().as_str() == "POST" {
    Level::DEBUG
} else {
    Level::INFO
};

// `level =` and name MUST come before the request, in this order
reqwest_otel_span!(level = level, name = "reqwest-http-request", request);
```


[`DefaultSpanBackend`]: crate::reqwest_otel_span_builder::DefaultSpanBackend
[`SpanBackendWithUrl`]: crate::reqwest_otel_span_builder::DefaultSpanBackend
[`default_on_request_success`]: crate::reqwest_otel_span_builder::default_on_request_success
[`default_on_request_failure`]: crate::reqwest_otel_span_builder::default_on_request_failure
[`default_on_request_end`]: crate::reqwest_otel_span_builder::default_on_request_end

```rust
pub macro_rules! reqwest_otel_span {
    /* macro_rules! reqwest_otel_span {
    (name=$name:expr, $request:ident) => { ... };
    (level=$level:expr, name=$name:expr, $request:ident) => { ... };
    (name=$name:expr, $request:ident, $($field:tt)*) => { ... };
    (level=$level:expr, name=$name:expr, $request:ident, $($field:tt)*) => { ... };
} */
}
```

## Re-exports

### Re-export `TracingMiddleware`

```rust
pub use middleware::TracingMiddleware;
```

### Re-export `default_on_request_end`

```rust
pub use reqwest_otel_span_builder::default_on_request_end;
```

### Re-export `default_on_request_failure`

```rust
pub use reqwest_otel_span_builder::default_on_request_failure;
```

### Re-export `default_on_request_success`

```rust
pub use reqwest_otel_span_builder::default_on_request_success;
```

### Re-export `default_span_name`

```rust
pub use reqwest_otel_span_builder::default_span_name;
```

### Re-export `DefaultSpanBackend`

```rust
pub use reqwest_otel_span_builder::DefaultSpanBackend;
```

### Re-export `DisableOtelPropagation`

```rust
pub use reqwest_otel_span_builder::DisableOtelPropagation;
```

### Re-export `OtelName`

```rust
pub use reqwest_otel_span_builder::OtelName;
```

### Re-export `OtelPathNames`

```rust
pub use reqwest_otel_span_builder::OtelPathNames;
```

### Re-export `ReqwestOtelSpanBackend`

```rust
pub use reqwest_otel_span_builder::ReqwestOtelSpanBackend;
```

### Re-export `SpanBackendWithUrl`

```rust
pub use reqwest_otel_span_builder::SpanBackendWithUrl;
```

### Re-export `ERROR_CAUSE_CHAIN`

```rust
pub use reqwest_otel_span_builder::ERROR_CAUSE_CHAIN;
```

### Re-export `ERROR_MESSAGE`

```rust
pub use reqwest_otel_span_builder::ERROR_MESSAGE;
```

### Re-export `HTTP_REQUEST_METHOD`

```rust
pub use reqwest_otel_span_builder::HTTP_REQUEST_METHOD;
```

### Re-export `HTTP_RESPONSE_STATUS_CODE`

```rust
pub use reqwest_otel_span_builder::HTTP_RESPONSE_STATUS_CODE;
```

### Re-export `OTEL_KIND`

```rust
pub use reqwest_otel_span_builder::OTEL_KIND;
```

### Re-export `OTEL_NAME`

```rust
pub use reqwest_otel_span_builder::OTEL_NAME;
```

### Re-export `OTEL_STATUS_CODE`

```rust
pub use reqwest_otel_span_builder::OTEL_STATUS_CODE;
```

### Re-export `SERVER_ADDRESS`

```rust
pub use reqwest_otel_span_builder::SERVER_ADDRESS;
```

### Re-export `SERVER_PORT`

```rust
pub use reqwest_otel_span_builder::SERVER_PORT;
```

### Re-export `URL_FULL`

```rust
pub use reqwest_otel_span_builder::URL_FULL;
```

### Re-export `URL_SCHEME`

```rust
pub use reqwest_otel_span_builder::URL_SCHEME;
```

### Re-export `USER_AGENT_ORIGINAL`

```rust
pub use reqwest_otel_span_builder::USER_AGENT_ORIGINAL;
```

